def vaultSecrets = [
  [
    path: 'kv/time-machine/lab',
    secretValues: [
      [vaultKey: "DJANGO_SECRET_KEY"],
      [vaultKey: "DJANGO_SUPERUSER_EMAIL"],
      [vaultKey: "DJANGO_SUPERUSER_PASSWORD"],
      [vaultKey: "DJANGO_SUPERUSER_USERNAME"],
      [vaultKey: "POSTGRESQL_PASSWORD"],
      [vaultKey: "POSTGRESQL_USERNAME"]
    ]
  ]
]

def PORT = 8000
def PYTHON_ENV = "lab"
def DJANGO_SETTINGS_MODULE = "time_machine.settings"
def DATABASE_HOST = "db"
def DATABASE_NAME = "timemachine"
def DATABASE_PORT = 5432
def APP_SLUG = "time-machine"

pipeline {
  agent any

  stages {
    stage("Verify Tooling") {
      steps {
        withVault([vaultSecrets: vaultSecrets]) {
          withEnv([
            "APP_SLUG=${APP_SLUG}",
            "PORT=${PORT}",
            "PYTHON_ENV=${PYTHON_ENV}",
            "DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}",
            "POSTGRESQL_HOST=${DATABASE_HOST}",
            "POSTGRESQL_PORT=${DATABASE_PORT}",
            "POSTGRESQL_DATABASE=${DATABASE_NAME}",
            'DATABASE_URL="${POSTGRESQL_USERNAME}:${POSTGRESQL_PASSWORD}@${DATABASE_HOST}:5432/${DATABASE_NAME}"'
          ]) {
            sh '''
              echo "Verifying tooling..."
              docker info
              docker version
              docker compose version
              docker compose -p ${APP_SLUG} -f deploy/lab/docker-compose.yml config
            '''
          }
        }
      }
    }

    stage("Deploy") {
      steps {
        withVault([vaultSecrets: vaultSecrets]) {
          withEnv([
            "APP_SLUG=${APP_SLUG}",
            "PORT=${PORT}",
            "PYTHON_ENV=${PYTHON_ENV}",
            "DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}",
            "POSTGRESQL_HOST=${DATABASE_HOST}",
            "POSTGRESQL_PORT=${DATABASE_PORT}",
            "POSTGRESQL_DATABASE=${DATABASE_NAME}",
            'DATABASE_URL="${POSTGRESQL_USERNAME}:${POSTGRESQL_PASSWORD}@${DATABASE_HOST}:5432/${DATABASE_NAME}"',
            'APP_NAME="Time Machine"',
            "HOMEPAGE_GROUP=Service",
            'HOMEPAGE_ICON=""'
          ]) {
            sh '''
              echo "Deploying..."
              docker build -t gitea.local.kvdomingo.dev/kvdomingo/${APP_SLUG}:latest --target prod --network host .
              docker compose --project-name ${APP_SLUG} --file deploy/lab/docker-compose.yml up --detach --remove-orphans
            '''
          }
        }
      }
    }
  }
}