def vaultSecrets = [
  [
    path: 'kv/time-machine/lab',
    secretValues: [
      [vaultKey: "DJANGO_SECRET_KEY"],
      [vaultKey: "DJANGO_SUPERUSER_EMAIL"],
      [vaultKey: "DJANGO_SUPERUSER_PASSWORD"],
      [vaultKey: "DJANGO_SUPERUSER_USERNAME"],
      [vaultKey: "POSTGRESQL_PASSWORD"],
      [vaultKey: "POSTGRESQL_USERNAME"]
    ]
  ]
]

def PORT = 8000
def PYTHON_ENV = "lab"
def DJANGO_SETTINGS_MODULE = "time_machine.settings"
def DATABASE_HOST = "db"
def DATABASE_NAME = "timemachine"
def DATABASE_PORT = 5432
def APP_SLUG = "time-machine"

def envs = [
  "APP_SLUG=${APP_SLUG}",
  "PORT=${PORT}",
  "PYTHON_ENV=${PYTHON_ENV}",
  "DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}",
  "POSTGRESQL_HOST=${DATABASE_HOST}",
  "POSTGRESQL_PORT=${DATABASE_PORT}",
  "POSTGRESQL_DATABASE=${DATABASE_NAME}",
  'DATABASE_URL="${POSTGRESQL_USERNAME}:${POSTGRESQL_PASSWORD}@${DATABASE_HOST}:5432/${DATABASE_NAME}"'
]

pipeline {
  agent any

  stages {
    stage("Verify Tooling") {
      steps {
        withVault([vaultSecrets: vaultSecrets]) {
          withEnv(envs) {
            sh '''
              echo "Verifying tooling..."
              docker info
              docker version
              docker compose version
              docker compose --project-name ${APP_SLUG} --file deploy/lab/docker-compose.yml config
            '''
          }
        }
      }
    }

    stage("Build") {
      steps {
        withVault([vaultSecrets: vaultSecrets]) {
          withEnv(envs) {
            sh '''
              echo "Building..."
              docker compose --project-name ${APP_SLUG} --file deploy/lab/docker-compose.yml build --no-cache
            '''
          }
        }
      }
    }

    stage("Deploy") {
      steps {
        withVault([vaultSecrets: vaultSecrets]) {
          withEnv(envs) {
            sh '''
              echo "Deploying..."
              docker compose --project-name ${APP_SLUG} --file deploy/lab/docker-compose.yml up --detach --remove-orphans
            '''
          }
        }
      }
    }
  }
}